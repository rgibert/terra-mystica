---
- hosts:
    - localhost
  vars:
    deploy_mode: devel # valid options: devel, staging, prod
    domain: localhost
    apache_port: 8081
  tasks:
    - name: enable non-free packages
      replace:
        path: /etc/apt/sources.list
        regexp: '^(.*) stretch main$'
        replace: '\1 stretch main non-free'

    - name: install system packages
      apt:
        name:
          - apache2
          - emacs
          - git
          - libapache2-mod-fastcgi
          - libpq-dev
          - perl
          - postgresql
      become: true

    - name: install cpan modules
      cpanm:
        name: "{{ item }}"
      become: true
      with_items:
        - Module::Install
        - Bytes::Random::Secure
        - CGI::PSGI
        - Clone
        - Crypt::Blowfish
        - Crypt::CBC
        - Crypt::Eksblowfish::Bcrypt
        - Data::Password::Common
        - DBD::Pg
        - DBI Digest::SHA1
        - Exporter::Easy
        - File::Slurp
        - indirect
        - JSON
        - Math::Random::MT
        - Method::Signatures::Simple
        - Moose
        - Readonly
        - Statistics::Descriptive
        - Task::Plack
        - Term::ReadLine
        - Text::Diff
        - Text::Template

    - name: create dirs
      file:
        name: "{{ item }}"
        state: directory
        recurse: true
      with_items:
        - "{{ playbook_dir }}/www-{{ deploy_mode }}/logs"
        - "{{ playbook_dir }}/www-{{ deploy_mode }}/data/logs"

    - name: run deploy.pl
      command: "perl ./deploy.pl www-{{ deploy_mode }}"
    
    - name: copy apache config
      template:
        src: config/apache.conf.j2
        dest: /etc/apache2/sites-available/terramystica.conf
      become: true
    
    - name: create enabled links
      file:
        state: link
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
      become: true
      with_items:
        - src: /etc/apache2/sites-available/terramystica.conf
          dest: /etc/apache2/sites-enabled/terramystica.conf
        - src: /etc/apache2/mods-available/headers.load
          dest: /etc/apache2/mods-enabled/headers.load
        - src: /etc/apache2/mods-available/rewrite.load
          dest: /etc/apache2/mods-enabled/rewrite.load
        
    - name: restart apache
      systemd:
        name: apache2
        state: restarted
      become: true
