---
- hosts:
    - localhost
  vars:
    deploy_mode: devel # valid options: devel, staging, prod
    domain: localhost
    apache_port: 8081
    fcgi_port: 7070
    num_fcgi_procs: 5
  tasks:
    - name: install system packages
      apt:
        name:
          - apache2
          - emacs
          - git
          - libapache2-mod-fastcgi
          - libpq-dev
          - perl
          - postgresql
      become: true

    - name: install cpan modules
      cpanm:
        name: "{{ item }}"
      become: true
      with_items:
        - Module::Install
        - Bytes::Random::Secure
        - CGI::PSGI
        - Clone
        - Crypt::Blowfish
        - Crypt::CBC
        - Crypt::Eksblowfish::Bcrypt
        - Data::Password::Common
        - DBD::Pg
        - DBI Digest::SHA1
        - Exporter::Easy
        - File::Slurp
        - indirect
        - JSON
        - Math::Random::MT
        - Method::Signatures::Simple
        - Moose
        - Readonly
        - Statistics::Descriptive
        - Task::Plack
        - Term::ReadLine
        - Text::Diff
        - Text::Template

    - name: install pip packages
      pip:
        name:
          - psycopg2

    - name: create dirs
      file:
        name: "{{ item }}"
        state: directory
        recurse: true
      with_items:
        - "{{ playbook_dir }}/www-{{ deploy_mode }}/logs"
        - "{{ playbook_dir }}/www-{{ deploy_mode }}/data/logs"

    - name: run deploy.pl
      command: "perl ./deploy.pl www-{{ deploy_mode }}"
    
    - name: copy templates
      template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ ansible_user_id }}"
      become: true
      with_items:
        - src: config/apache.conf.j2
          dest: /etc/apache2/sites-available/terramystica.conf
        - src: conf/terra-mystica.service.j2
          dest: /etc/systemd/system/terra-mystica.service
    
    - name: create enabled links
      file:
        state: link
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ ansible_user_id }}"
      become: true
      with_items:
        - src: /etc/apache2/sites-available/terramystica.conf
          dest: /etc/apache2/sites-enabled/terramystica.conf
        - src: /etc/apache2/mods-available/headers.load
          dest: /etc/apache2/mods-enabled/headers.load
        - src: /etc/apache2/mods-available/proxy.conf
          dest: /etc/apache2/mods-enabled/proxy.conf
        - src: /etc/apache2/mods-available/proxy.load
          dest: /etc/apache2/mods-enabled/proxy.load
        - src: /etc/apache2/mods-available/proxy_fcgi.load
          dest: /etc/apache2/mods-enabled/proxy_fcgi.load
        - src: /etc/apache2/mods-available/rewrite.load
          dest: /etc/apache2/mods-enabled/rewrite.load

    - name: start/enable service
      systemd:
        name: terra-mystica
        state: started
        enabled: true

    - name: restart apache
      systemd:
        name: apache2
        state: restarted
      become: true
