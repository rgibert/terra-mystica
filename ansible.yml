---
- hosts:
    - localhost
  vars:
    deploy_mode: devel # valid options: devel, staging, prod
    domain: localhost
    apache_port: 8081
  tasks:
    - name: install system packages
      apt:
        name:
          - apache2
          - libapache2-mod-fcgid
          - libpq-dev
          - perl
          - postgresql
      become: true

    - name: install cpan modules
      cpanm:
        name: "{{ item }}"
      become: true
      with_items:
        - Module::Install
        - Bytes::Random::Secure
        - CGI::PSGI
        - Clone
        - Crypt::Blowfish
        - Crypt::CBC
        - Crypt::Eksblowfish::Bcrypt
        - Data::Password::Common
        - DBD::Pg
        - DBI Digest::SHA1
        - Exporter::Easy
        - File::Slurp
        - indirect
        - JSON
        - Math::Random::MT
        - Method::Signatures::Simple
        - Moose
        - Readonly
        - Statistics::Descriptive
        - Task::Plack
        - Term::ReadLine
        - Text::Diff
        - Text::Template

    - name: create dirs
      file:
        name: "{{ item }}"
      with_items:
        - "www-${deploy_mode}/logs"
        - "www-${deploy_mode}/data/logs"

    - name: run deploy.pl
      command: "./deploy.pl www-${deploy_mode}"
    
    - name: copy apache config
      template:
        src: config/apache.conf.j2
        dest: /etc/apache2/sites-available/terramystica.conf
      become: true
    
    - name: restart apache
      systemd:
        name: apache2
        state: restarted
      become: true
